name: Trivy Scan with Artifact

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  trivy-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Run Trivy Scan
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: 'fs'                # Scan filesystem
          directory: '.'                  # Directory to scan
          format: 'json'                  # JSON format for artifact
          output: 'trivy-report.json'     # Save report
          exit-code: '0'                  # Optional: continue workflow even if vulnerabilities found
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy Report
        uses: actions/upload-artifact@v3
        with:
          name: trivy-report
          path: trivy-report.json
